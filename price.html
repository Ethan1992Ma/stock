<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>價目表查詢</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", Roboto, "Helvetica Neue", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; margin: 0; }
    #cart-bar {
      position: sticky; top: 0; background: #fff; padding: 10px;
      border-bottom: 1px solid #eee; z-index: 1000;
    }
    #cart-bar .total { font-weight: 700; }
    #cart-list .item { display:flex; align-items:center; justify-content: space-between; padding:4px 0; border-bottom:1px dashed #eee; }
    #cart-list .qty button { padding:2px 6px; margin: 0 3px; }
    #search { width: 100%; padding: 10px; font-size: 16px; border: none; border-bottom: 1px solid #eee; }
    table { width: 100%; border-collapse: collapse; font-size: 15px; }
    th, td { border-bottom: 1px solid #f0f0f0; padding: 10px; text-align: left; }
    th { background: #fafafa; position: sticky; top: 58px; z-index: 500; }
    .name { color: #2563eb; cursor: pointer; text-decoration: underline; }
    .muted { color: #888; }
    .price { white-space: nowrap; }
    /* modal */
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,.45); align-items:center; justify-content:center; padding:14px; }
    .modal .box { background:#fff; max-width:720px; width:100%; max-height:85vh; overflow:auto; border-radius:10px; padding:16px 18px; }
    .box h3 { margin: 0 0 8px 0; }
    .box h4 { margin: 14px 0 6px; }
    .close { float:right; cursor:pointer; }
  </style>
</head>
<body>
  <div id="cart-bar">
    <div>
      <strong>購物車總額：</strong><span id="cart-total" class="total">0</span> 元
      <span class="muted">（表格顯示原價，加入購物車後自動 95 折）</span>
      <button id="clear-cart" style="margin-left:8px;">清空</button>
    </div>
    <div id="cart-list"></div>
  </div>

  <input id="search" type="text" placeholder="搜尋品名（支援模糊，例如：banxiazhu… 或 半夏）…" />

  <table>
    <thead>
      <tr>
        <th style="width:72px;">選擇</th>
        <th>品名</th>
        <th style="width:120px;">原價</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- 詳細資訊 Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <span class="close" onclick="hideModal()">✕</span>
      <div id="modal-body"></div>
    </div>
  </div>

<script>
const DISCOUNT = 0.95; // 95 折只在購物車計算

let DATA = [];
let CART = {}; // name -> qty

// 載入資料（與 price.html 同資料夾）
fetch('drugs.json', {cache: 'no-store'})
  .then(r => r.json())
  .then(json => {
    // 僅保留需要的四個欄位，忽略任何 efficacy
    DATA = json.map(x => ({
      name: String(x.name || ''),
      price: Number(x.price || 0),
      composition: (x.composition || '').trim(),
      indications: (x.indications || '').trim()
    }));
    renderTable();
  });

// 簡易模糊包含（忽略空白）
function match(text, query) {
  if (!query) return true;
  const t = (text || '').replace(/\s+/g, '');
  const q = query.replace(/\s+/g, '');
  return t.includes(q);
}

const $tbody = document.getElementById('tbody');
const $search = document.getElementById('search');
const $cartList = document.getElementById('cart-list');
const $cartTotal = document.getElementById('cart-total');

function renderTable(filter="") {
  $tbody.innerHTML = "";
  DATA.forEach(item => {
    if (!match(item.name, filter)) return;
    const tr = document.createElement('tr');
    const priceText = item.price > 0 ? `${item.price} 元` : `<span class="muted">—</span>`;
    tr.innerHTML = `
      <td>
        <button data-act="add" data-name="${item.name}" ${item.price<=0 ? 'disabled' : ''}>加入</button>
      </td>
      <td>
        <span class="name" data-act="show" data-name="${item.name}">${item.name}</span>
      </td>
      <td class="price">${priceText}</td>
    `;
    $tbody.appendChild(tr);
  });
}

function renderCart() {
  $cartList.innerHTML = "";
  let total = 0;
  Object.entries(CART).forEach(([name, qty]) => {
    const item = DATA.find(d => d.name === name);
    if (!item) return;
    const discounted = Math.round(item.price * DISCOUNT);
    const sub = discounted * qty;
    total += sub;

    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div>${name} <span class="muted">（${discounted} 元/95折）</span></div>
      <div class="qty">
        <button data-act="dec" data-name="${name}">−</button>
        <strong>${qty}</strong>
        <button data-act="inc" data-name="${name}">＋</button>
        <span style="margin-left:8px;">= ${sub} 元</span>
      </div>
    `;
    $cartList.appendChild(row);
  });
  $cartTotal.textContent = total;
}

document.body.addEventListener('click', (e) => {
  const act = e.target.getAttribute('data-act');
  const name = e.target.getAttribute('data-name');
  if (!act) return;

  if (act === 'add') {
    CART[name] = (CART[name] || 0) + 1;
    renderCart();
  }
  if (act === 'inc' && CART[name] > 0) {
    CART[name] += 1; renderCart();
  }
  if (act === 'dec' && CART[name] > 1) {
    CART[name] -= 1; renderCart();
  } else if (act === 'dec' && CART[name] === 1) {
    delete CART[name]; renderCart();
  }
  if (act === 'show') {
    showDetail(name);
  }
});

document.getElementById('clear-cart').addEventListener('click', () => {
  CART = {}; renderCart();
});

$search.addEventListener('input', (e) => renderTable((e.target.value || '').trim()));

function showDetail(name) {
  const item = DATA.find(d => d.name === name);
  if (!item) return;

  const comp = item.composition ? `
      <h4>藥物組成</h4>
      ${renderBulletLines(item.composition)}
  ` : `<div class="muted">（尚無成分資料）</div>`;

  const ind  = item.indications ? `
      <h4>適應症</h4>
      ${renderBulletLines(item.indications)}
  ` : `<div class="muted">（尚無適應症資料）</div>`;

  // 只渲染成分與適應症，完全不渲染「效能」
  document.getElementById('modal-body').innerHTML = `
    <h3>${escapeHtml(name)}</h3>
    ${comp}
    ${ind}
  `;
  document.getElementById('modal').style.display = 'flex';
}

function hideModal(){ document.getElementById('modal').style.display = 'none'; }
function escapeHtml(s){ return (s||'').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

// 將多行文字（或用頓號/逗號分隔）渲染為項目符號
function renderBulletLines(text) {
  const raw = (text || "").replace(/\r/g, "");
  // 先用換行拆；若只有一行再試著用頓號/、/、逗號拆解
  let lines = raw.split("\n").map(s => s.trim()).filter(Boolean);
  if (lines.length <= 1) {
    lines = raw.split(/[、，,；;•·‧]+/).map(s => s.trim()).filter(Boolean);
  }
  if (!lines.length) return `<div class="muted">（無）</div>`;
  return `<ul>${lines.map(li => `<li>${escapeHtml(li)}</li>`).join("")}</ul>`;
}

// 首次渲染（防止資料尚未載入時的空白）
renderTable();
</script>
</body>
</html>
