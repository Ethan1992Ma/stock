<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>價目表查詢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #cart-bar {
      position: sticky; top: 0; background: #f8f8f8; padding: 10px;
      border-bottom: 2px solid #ccc; z-index: 1000;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .name { color: blue; cursor: pointer; text-decoration: underline; }
    .cart-item { margin: 5px 0; }
    .qty-btn { cursor: pointer; margin: 0 3px; }
    /* modal */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; max-width: 90%; max-height: 80%;
      overflow-y: auto; border-radius: 8px;
    }
    .modal-content h3 { margin-top: 0; }
    .modal-content pre { white-space: pre-wrap; line-height: 1.4; }
  </style>
</head>
<body>
  <div id="cart-bar">
    <strong>購物車總額：</strong><span id="cart-total">0</span> 元（95折已含）
    <div id="cart-list"></div>
  </div>

  <input type="text" id="search" placeholder="搜尋品名..." style="width:100%;padding:8px;">

  <table id="price-table">
    <thead>
      <tr>
        <th>選擇</th><th>品名</th><th>原價</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>

  <!-- modal -->
  <div class="modal" id="info-modal">
    <div class="modal-content" id="modal-content"></div>
  </div>

<script>
let priceData = {};
let drugInfo = {};
const cart = {};
const tableBody = document.getElementById("table-body");
const cartList = document.getElementById("cart-list");
const cartTotal = document.getElementById("cart-total");

// 載入 drugs_final.json
fetch("drugs_final.json")
  .then(res => res.json())
  .then(data => {
    data.forEach(d => {
      priceData[d.name] = d.price;
      drugInfo[d.name] = {
        composition: d.composition,
        efficacy: d.efficacy,
        indications: d.indications
      };
    });
    renderTable();
  });

// 渲染表格
function renderTable(filter="") {
  tableBody.innerHTML = "";
  for (let name in priceData) {
    if (name.includes(filter)) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="checkbox" data-name="${name}"></td>
        <td><span class="name" data-name="${name}">${name}</span></td>
        <td>${priceData[name]} 元</td>
      `;
      tableBody.appendChild(row);
    }
  }
}

// 更新購物車
function updateCart() {
  cartList.innerHTML = "";
  let total = 0;
  for (let name in cart) {
    let qty = cart[name];
    let discountPrice = Math.round(priceData[name] * 0.95);
    total += discountPrice * qty;
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      ${name} - ${discountPrice} 元 x 
      <span class="qty-btn" data-name="${name}" data-action="minus">➖</span>
      ${qty}
      <span class="qty-btn" data-name="${name}" data-action="plus">➕</span>
      = ${discountPrice * qty} 元
    `;
    cartList.appendChild(div);
  }
  cartTotal.textContent = total;
}

// 搜尋
document.getElementById("search").addEventListener("input", e=>{
  renderTable(e.target.value.trim());
});

// 點藥名看詳細
document.body.addEventListener("click", e=>{
  if(e.target.classList.contains("name")){
    const name = e.target.dataset.name;
    const info = drugInfo[name];
    if(info){
      document.getElementById("modal-content").innerHTML = `
        <h3>${name}</h3>
        <h4>【藥物組成】</h4>
        <pre>${info.composition || "－"}</pre>
        <h4>【效能】</h4>
        <pre>${info.efficacy || "－"}</pre>
        <h4>【適應症】</h4>
        <pre>${info.indications || "－"}</pre>
        <button onclick="closeModal()">關閉</button>
      `;
      document.getElementById("info-modal").style.display = "flex";
    }
  }
});

// 勾選加入購物車
document.body.addEventListener("change", e=>{
  if(e.target.type==="checkbox"){
    const name = e.target.dataset.name;
    if(e.target.checked){
      cart[name] = 1;
    } else {
      delete cart[name];
    }
    updateCart();
  }
});

// 調整數量
document.body.addEventListener("click", e=>{
  if(e.target.classList.contains("qty-btn")){
    const name = e.target.dataset.name;
    const action = e.target.dataset.action;
    if(action==="plus") cart[name]++;
    if(action==="minus" && cart[name]>1) cart[name]--;
    updateCart();
  }
});

function closeModal(){
  document.getElementById("info-modal").style.display = "none";
}
</script>
</body>
</html>
