<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>價目表查詢</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bar-h:56px;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",Roboto,"Helvetica Neue",Arial,"PingFang TC","Microsoft JhengHei",sans-serif;margin:0;background:#fff;color:#111;}
    /* cart bar */
    #cart-bar{position:sticky;top:0;z-index:1200;background:#fff;border-bottom:1px solid #eee;padding:10px;}
    #cart-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    #cart-top .total{font-weight:700}
    #cart-toggle{border:1px solid #ddd;background:#f8f8f8;border-radius:6px;padding:4px 8px}
    #cart-list{margin-top:6px;border-top:1px dashed #eee;display:none;max-height:38vh;overflow:auto}
    #cart-list.show{display:block}
    #cart-list .item{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee}
    #cart-list .qty button{padding:2px 8px;margin:0 3px}
    #search{width:100%;padding:10px 12px;font-size:16px;border:none;border-bottom:1px solid #eee}
    table{width:100%;border-collapse:collapse;font-size:15px}
    th,td{padding:12px 10px;border-bottom:1px solid #f1f1f1;text-align:left;vertical-align:top}
    th{background:#fafafa; /* 不再 sticky */}
    .name{color:#2563eb;cursor:pointer;text-decoration:underline}
    .muted{color:#888}
    .price{white-space:nowrap}
    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:3000;align-items:center;justify-content:center;padding:14px}
    .modal .box{background:#fff;max-width:720px;width:100%;max-height:85vh;overflow:auto;border-radius:10px;padding:16px 18px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal .box h3{margin:0 0 8px}
    .modal .box h4{margin:14px 0 6px}
    .close{position:sticky;top:0;float:right;cursor:pointer;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:4px 8px}
    /* mobile checkbox size */
    input[type=checkbox]{width:20px;height:20px}
    .btn{border:1px solid #ddd;background:#f8f8f8;border-radius:6px;padding:6px 10px}
  </style>
</head>
<body>
  <div id="cart-bar">
    <div id="cart-top">
      <strong>購物車總額：<span id="cart-total" class="total">0</span> 元</strong>
      <span class="muted">（表格顯示原價，加入購物車後自動 95 折）</span>
      <button id="cart-toggle" class="btn" aria-expanded="false">展開明細</button>
      <button id="clear-cart" class="btn">清空</button>
    </div>
    <div id="cart-list"></div>
  </div>

  <input id="search" type="text" placeholder="搜尋品名（支援模糊，例如：半夏…）" />

  <table>
    <thead>
      <tr>
        <th style="width:64px;">選擇</th>
        <th>品名</th>
        <th style="width:120px;">原價</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- 詳細資訊 Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 id="m-title" style="margin:0"></h3>
        <button class="close" onclick="hideModal()">關閉</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

<script>
const DISCOUNT = 0.95; // 95折只在購物車計算
let DATA = [];
let CART = {}; // name -> qty
let cartExpanded = false;

// 讀取資料
fetch('drugs.json', {cache:'no-store'})
  .then(r=>r.json())
  .then(json=>{
    DATA = json.map(x => ({
      name: String(x.name||''),
      price: Number(x.price||0),
      composition: (x.composition||'').trim(),
      indications: (x.indications||'').trim()
    }));
    renderTable();
  });

/* 工具 */
function escapeHtml(s){return (s||'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))}
function linesToUl(text){
  const raw=(text||'').replace(/\r/g,'');
  let arr = raw.split('\n').map(s=>s.trim()).filter(Boolean);
  if(arr.length<=1){arr = raw.split(/[、，,；;•·‧]+/).map(s=>s.trim()).filter(Boolean);}
  if(!arr.length) return '<div class="muted">（無）</div>';
  return `<ul>${arr.map(li=>`<li>${escapeHtml(li)}</li>`).join('')}</ul>`;
}
function fuzzyIncludes(full, q){
  if(!q) return true;
  const t = String(full||'').replace(/\s+/g,'');
  const s = String(q||'').replace(/\s+/g,'');
  return t.includes(s);
}

/* DOM refs */
const $tbody = document.getElementById('tbody');
const $search = document.getElementById('search');
const $cartList = document.getElementById('cart-list');
const $cartTotal = document.getElementById('cart-total');
const $cartToggle = document.getElementById('cart-toggle');

function renderTable(filter=""){
  $tbody.innerHTML = "";
  DATA.forEach(item=>{
    if(!fuzzyIncludes(item.name, filter)) return;
    const tr = document.createElement('tr');
    const checked = CART[item.name] ? 'checked' : '';
    const disabled = item.price<=0 ? 'disabled' : '';
    const priceText = item.price>0 ? `${item.price} 元` : `<span class="muted">—</span>`;
    tr.innerHTML = `
      <td><input type="checkbox" class="sel" data-name="${item.name}" ${checked} ${disabled}></td>
      <td><a href="javascript:void(0)" class="name" data-act="show" data-name="${item.name}">${item.name}</a></td>
      <td class="price">${priceText}</td>
    `;
    $tbody.appendChild(tr);
  });
}

function renderCart(){
  $cartList.innerHTML = "";
  let total = 0;
  Object.entries(CART).forEach(([name, qty])=>{
    const item = DATA.find(d=>d.name===name);
    if(!item) return;
    const disc = Math.round(item.price * DISCOUNT);
    const sub = disc * qty;
    total += sub;
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div>${escapeHtml(name)} <span class="muted">（${disc} 元/95折）</span></div>
      <div class="qty">
        <button class="btn" data-act="dec" data-name="${name}">−</button>
        <strong>${qty}</strong>
        <button class="btn" data-act="inc" data-name="${name}">＋</button>
        <button class="btn" data-act="rm" data-name="${name}" style="margin-left:6px">移除</button>
        <span style="margin-left:8px;">= ${sub} 元</span>
      </div>
    `;
    $cartList.appendChild(row);
  });
  $cartTotal.textContent = total;
}

/* 事件 */
$search.addEventListener('input', e=> renderTable((e.target.value||'').trim()));

document.body.addEventListener('change', e=>{
  if(e.target.classList.contains('sel')){
    const name = e.target.dataset.name;
    if(e.target.checked){
      CART[name] = CART[name] ? CART[name] : 1;
    }else{
      delete CART[name];
    }
    renderCart();
  }
});

document.body.addEventListener('click', e=>{
  const act = e.target.getAttribute('data-act');
  const name = e.target.getAttribute('data-name');

  if(act === 'show'){
    showDetail(name);
    return;
  }
  if(act === 'inc' && CART[name]){
    CART[name] += 1; syncCheckbox(name,true); renderCart(); return;
  }
  if(act === 'dec' && CART[name]){
    if(CART[name] > 1){ CART[name] -= 1; }
    else { delete CART[name]; syncCheckbox(name,false); }
    renderCart(); return;
  }
  if(act === 'rm' && CART[name]){
    delete CART[name]; syncCheckbox(name,false); renderCart(); return;
  }
});

document.getElementById('clear-cart').addEventListener('click', ()=>{
  CART = {};
  document.querySelectorAll('input.sel:checked').forEach(cb=>cb.checked=false);
  renderCart();
});

$cartToggle.addEventListener('click', ()=>{
  cartExpanded = !cartExpanded;
  $cartList.classList.toggle('show', cartExpanded);
  $cartToggle.textContent = cartExpanded ? '收合明細' : '展開明細';
  $cartToggle.setAttribute('aria-expanded', String(cartExpanded));
});

/* 同步表格勾選狀態（避免搜尋重新渲染後遺失） */
function syncCheckbox(name, checked){
  const cb = document.querySelector(`input.sel[data-name="${CSS.escape(name)}"]`);
  if(cb) cb.checked = !!checked;
}

/* 詳細資訊 */
function showDetail(name){
  const item = DATA.find(d=>d.name===name);
  if(!item) return;
  document.getElementById('m-title').textContent = name;

  const comp = item.composition ? `<h4>藥物組成</h4>${linesToUl(item.composition)}` : `<div class="muted">（尚無成分資料）</div>`;
  const ind  = item.indications ? `<h4>適應症</h4>${linesToUl(item.indications)}` : `<div class="muted">（尚無適應症資料）</div>`;

  document.getElementById('modal-body').innerHTML = `${comp}${ind}`;
  document.getElementById('modal').style.display = 'flex';
  document.body.style.overflow = 'hidden'; // 鎖背景卷動
}
function hideModal(){
  document.getElementById('modal').style.display = 'none';
  document.body.style.overflow = '';
}

/* 初次渲染 */
renderTable();
</script>
</body>
</html>
